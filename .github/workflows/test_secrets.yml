name: Test Secrets

on:
  workflow_dispatch:

jobs:
  test-connection:
    runs-on: ubuntu-latest
    steps:
      - name: Check Secrets
        env:
          DB_URL: ${{ secrets.DIVIDENDSPRO_DATABASE_URL }}
          KEY: ${{ secrets.LEDGER_PRIVATE_KEY }}
        run: |
          if [ -z "$DB_URL" ]; then
            echo "::error::DIVIDENDSPRO_DATABASE_URL secret is missing or empty!"
            exit 1
          else
            echo "DIVIDENDSPRO_DATABASE_URL is set (length: ${#DB_URL})"
          fi
          
          if [ -z "$KEY" ]; then
             echo "::error::LEDGER_PRIVATE_KEY secret is missing or empty!"
             exit 1
          else
             echo "LEDGER_PRIVATE_KEY is set (length: ${#KEY})"
          fi
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install psycopg2-binary
        
      - name: Test DB Connectivity
        env:
          DB_URL: ${{ secrets.DIVIDENDSPRO_DATABASE_URL }}
        run: |
          python -c "
          import psycopg2
          import os
          try:
              conn = psycopg2.connect(os.environ['DB_URL'])
              print('Successfully connected to Supabase!')
              conn.close()
          except Exception as e:
              print(f'Connection failed: {e}')
              exit(1)
          "
